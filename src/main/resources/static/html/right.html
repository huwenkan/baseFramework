<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限控制管理</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="../js/utils/httpUtils.js"></script>
</head>
<body>
<div id="app">
    <el-container>
        <!-- 左侧菜单 -->
        <el-aside width="200px" style="background-color: #f5f5f5;">
            <el-menu
                    default-active="role"
                    class="el-menu-vertical-demo"
                    @select="handleMenuSelect"
                    background-color="#f5f5f5"
                    text-color="#333"
                    active-text-color="#409EFF">
                <el-menu-item index="role">角色管理</el-menu-item>
                <el-menu-item index="button">按钮权限管理</el-menu-item>
                <el-menu-item index="resource">资源权限管理</el-menu-item>
            </el-menu>
        </el-aside>

        <!-- 右侧内容 -->
        <el-main style="padding: 20px;">
            <div v-if="currentTab === 'role'">
                <el-row>
                    <el-col :span="24">
                        <el-button type="primary" @click="openRoleDialog">新增角色</el-button>
                        <el-table :data="roles" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="roleName" label="角色名称" width="180"></el-table-column>
                            <el-table-column prop="description" label="角色描述" width="200"></el-table-column>
                            <el-table-column label="操作">
                                <template slot-scope="scope">
                                    <el-button @click="editRole(scope.row)" size="mini">编辑</el-button>
                                    <el-button @click="deleteRole(scope.row)" type="danger" size="mini">删除</el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-pagination
                                @size-change="handleRoleSizeChange"
                                @current-change="handleRoleCurrentChange"
                                :current-page="roleCurrentPage"
                                :page-sizes="[10, 20, 50, 100]"
                                :page-size="rolePageSize"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="roleTotal">
                        </el-pagination>
                    </el-col>
                </el-row>
            </div>


            <div v-if="currentTab === 'button'">
                <el-row>
                    <el-col :span="24">
                        <el-button type="primary" @click="openButtonDialog">新增按钮</el-button>
                        <el-table :data="buttons" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="buttonName" label="按钮名称" width="180"></el-table-column>
                            <el-table-column prop="description" label="按钮描述" width="200"></el-table-column>
                            <el-table-column label="操作">
                                <template slot-scope="scope">
                                    <el-button @click="editButton(scope.row)" size="mini">编辑</el-button>
                                    <el-button @click="deleteButton(scope.row)" type="danger" size="mini">删除
                                    </el-button>
                                    <el-button @click="assignButtonPermissions(scope.row)" type="info" size="mini">
                                        分配角色
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-pagination
                                @size-change="handleButtonSizeChange"
                                @current-change="handleButtonCurrentChange"
                                :current-page="buttonCurrentPage"
                                :page-sizes="[10, 20, 50, 100]"
                                :page-size="buttonPageSize"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="buttonTotal">
                        </el-pagination>
                    </el-col>
                </el-row>
            </div>

            <div v-if="currentTab === 'resource'">
                <el-row>
                    <el-col :span="24">
                        <el-button type="primary" @click="openResourceDialog">新增资源</el-button>
                        <el-table :data="resources" style="width: 100%; margin-top: 20px;">
                            <el-table-column prop="resourceName" label="资源名称" width="180"></el-table-column>
                            <el-table-column prop="description" label="资源描述" width="200"></el-table-column>
                            <el-table-column label="操作">
                                <template slot-scope="scope">
                                    <el-button @click="editResource(scope.row)" size="mini">编辑</el-button>
                                    <el-button @click="deleteResource(scope.row)" type="danger" size="mini">删除
                                    </el-button>
                                    <el-button @click="assignResourcePermissions(scope.row)" type="info" size="mini">
                                        分配角色
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-pagination
                                @size-change="handleResourceSizeChange"
                                @current-change="handleResourceCurrentChange"
                                :current-page="resourceCurrentPage"
                                :page-sizes="[10, 20, 50, 100]"
                                :page-size="resourcePageSize"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="resourceTotal">
                        </el-pagination>
                    </el-col>
                </el-row>
            </div>

        </el-main>
    </el-container>

    <!-- 角色配置对话框 -->
    <el-dialog title="角色配置" :visible.sync="roleDialogVisible">
        <el-form :model="roleForm">
            <el-form-item label="角色名称" :label-width="formLabelWidth">
                <el-input v-model="roleForm.roleName" placeholder="请输入角色名称"></el-input>
            </el-form-item>
            <el-form-item label="角色描述" :label-width="formLabelWidth">
                <el-input v-model="roleForm.description" placeholder="请输入角色描述"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="roleDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="saveRole">确 定</el-button>
        </span>
    </el-dialog>

    <!-- 按钮配置对话框 -->
    <el-dialog title="按钮配置" :visible.sync="buttonDialogVisible">
        <el-form :model="buttonForm">
            <el-form-item label="按钮名称" :label-width="formLabelWidth">
                <el-input v-model="buttonForm.buttonName" placeholder="请输入按钮名称"></el-input>
            </el-form-item>
            <el-form-item label="按钮描述" :label-width="formLabelWidth">
                <el-input v-model="buttonForm.description" placeholder="请输入按钮描述"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
        <el-button @click="buttonDialogVisible = false">取 消</el-button>
        <el-button type="primary" @click="saveButton">确 定</el-button>
    </span>
    </el-dialog>


    <!-- 资源配置对话框 -->
    <el-dialog title="资源配置" :visible.sync="resourceDialogVisible">
        <el-form :model="resourceForm">
            <el-form-item label="资源名称" :label-width="formLabelWidth">
                <el-input v-model="resourceForm.resourceName" placeholder="请输入资源名称"></el-input>
            </el-form-item>
            <el-form-item label="资源描述" :label-width="formLabelWidth">
                <el-input v-model="resourceForm.description" placeholder="请输入资源描述"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
        <el-button @click="resourceDialogVisible = false">取 消</el-button>
        <el-button type="primary" @click="saveResource">确 定</el-button>
    </span>
    </el-dialog>

    <!-- 分配角色对话框 -->
    <el-dialog title="分配角色" :visible.sync="assignDialogVisible" width="500px">
        <el-form :model="assignForm">
            <el-form-item label="选择角色" :label-width="formLabelWidth">
                <el-select v-model="assignForm.selectedRoles" multiple filterable placeholder="请选择角色"
                           style="width: 100%">
                    <el-option
                            v-for="role in allRoles"
                            :key="role.id"
                            :label="role.roleName"
                            :value="role.id">
                    </el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="assignDialogVisible = false">取 消</el-button>
            <el-button type="primary" @click="confirmAssignPermissions">确 定</el-button>
        </span>
    </el-dialog>

</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                currentTab: 'role', // 当前选中的菜单项
                // 角色分页数据
                roles: [],
                roleCurrentPage: 1,
                rolePageSize: 10,
                roleTotal: 0,
                // 按钮分页数据
                buttons: [],
                buttonCurrentPage: 1,
                buttonPageSize: 10,
                buttonTotal: 0,
                // 资源分页数据
                resources: [],
                resourceCurrentPage: 1,
                resourcePageSize: 10,
                resourceTotal: 0,
                roleDialogVisible: false, // 角色配置对话框
                buttonDialogVisible: false, // 按钮配置对话框
                resourceDialogVisible: false, // 资源配置对话框
                assignDialogVisible: false, // 分配角色对话框
                roleForm: {roleName: '', description: ''}, // 角色表单
                buttonForm: {buttonName: '', description: ''}, // 按钮表单
                resourceForm: {resourceName: '', description: ''}, // 资源表单
                assignForm: { // 分配角色表单
                    type: '', // 'button' 或 'resource'
                    id: '',
                    selectedRoles: []
                },
                allRoles: [], // 所有角色数据
                formLabelWidth: '100px'
            };
        },
        methods: {
            // 分配按钮权限
            assignButtonPermissions(button) {
                this.assignForm = {
                    type: 'button',
                    id: button.id,
                    selectedRoles: []
                };
                this.loadAssignedRoles(button.id, 'button');
                this.assignDialogVisible = true;
            },
            // 分配资源权限
            assignResourcePermissions(resource) {
                this.assignForm = {
                    type: 'resource',
                    id: resource.id,
                    selectedRoles: []
                };
                this.loadAssignedRoles(resource.id, 'resource');
                this.assignDialogVisible = true;
            },
            // 加载已分配的角色
            loadAssignedRoles(id, type) {
                HttpUtils.httpRequest({
                    url: `/right/getAssignedRoles`,
                    type: 'GET',
                    data: {
                        id: id,
                        type: type
                    },
                    success: (response) => {
                        this.assignForm.selectedRoles = response.data.map(role => role.id);
                    },
                    error: (error) => {
                        this.$message.error('加载已分配角色失败');
                    }
                });
            },
            // 确认分配权限
            confirmAssignPermissions() {
                HttpUtils.httpRequest({
                    url: '/right/assignPermissions',
                    type: 'POST',
                    data: {
                        id: this.assignForm.id,
                        roleIds: this.assignForm.selectedRoles,
                        type: this.assignForm.type
                    },
                    success: (response) => {
                        this.assignDialogVisible = false;
                        this.$message.success(response.message || '分配成功');
                    },
                    error: (response) => {
                        this.$message.error(response.message || '分配失败');
                    }
                });
            },
            getAllRoles() {
                HttpUtils.httpRequest({
                    url: '/right/getAllRoles', // 假设后端提供此接口
                    type: 'GET',
                    success: (response) => {
                        this.allRoles = response.data;
                    },
                    error: (error) => {
                        this.$message.error('获取角色列表失败');
                    }
                });
            },
            handleMenuSelect(index) {
                this.currentTab = index;
                // 根据当前选项卡调用对应的查询方法
                if (index === 'role') {
                    this.queryRoles();
                } else if (index === 'button') {
                    this.queryButtons();
                } else if (index === 'resource') {
                    this.queryResources();
                }
            },
            // 查询角色数据
            queryRoles() {
                HttpUtils.httpRequest({
                    url: '/right/getRole',
                    type: 'GET',
                    data: {
                        pageNum: this.currentPage,
                        pageSize: this.pageSize
                    },
                    success: (response) => {
                        this.roles = response.data.records;
                        this.roleTotal = response.data.total;
                    }
                });
            },
            handleRoleSizeChange(val) {
                this.rolePageSize = val;
                this.queryRoles();
            },
            handleRoleCurrentChange(val) {
                this.roleCurrentPage = val;
                this.queryRoles();
            },
            // 按钮分页方法
            queryButtons() {
                HttpUtils.httpRequest({
                    url: '/right/getButton',
                    type: 'GET',
                    data: {
                        pageNum: this.buttonCurrentPage,
                        pageSize: this.buttonPageSize
                    },
                    success: (response) => {
                        this.buttons = response.data.records;
                        this.buttonTotal = response.data.total;
                    }
                });
            },
            handleButtonSizeChange(val) {
                this.buttonPageSize = val;
                this.queryButtons();
            },
            handleButtonCurrentChange(val) {
                this.buttonCurrentPage = val;
                this.queryButtons();
            },
            // 资源分页方法
            queryResources() {
                HttpUtils.httpRequest({
                    url: '/right/getResource',
                    type: 'GET',
                    data: {
                        pageNum: this.resourceCurrentPage,
                        pageSize: this.resourcePageSize
                    },
                    success: (response) => {
                        this.resources = response.data.records;
                        this.resourceTotal = response.data.total;
                    }
                });
            },
            handleResourceSizeChange(val) {
                this.resourcePageSize = val;
                this.queryResources();
            },
            handleResourceCurrentChange(val) {
                this.resourceCurrentPage = val;
                this.queryResources();
            },
            // 打开角色对话框
            openRoleDialog() {
                this.roleForm = {roleName: '', description: ''};
                this.roleDialogVisible = true;
            },
            saveRole() {
                const url = this.roleForm.id ? '/right/updateRole' : '/right/saveRole';
                HttpUtils.httpRequest({
                    url: url,
                    type: 'POST',
                    data: this.roleForm,
                    success: (response) => {
                        this.queryRoles();
                        this.$message.success(response.message || (this.roleForm.id ? '更新成功' : '新增成功'));
                    },
                    error: (response) => {
                        this.$message.error(response.message || (this.roleForm.id ? '更新失败' : '新增失败'));
                    }
                });
                this.roleDialogVisible = false;
            },
            editRole(role) {
                this.roleForm = {
                    id: role.id,
                    roleName: role.roleName,
                    description: role.description
                };
                this.roleDialogVisible = true;
            },
            deleteRole(role) {
                this.$confirm('确定要删除此角色吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    HttpUtils.httpRequest({
                        url: '/right/deleteRole',
                        type: 'POST',
                        data: {id: role.id},
                        success: (response) => {
                            this.queryRoles();
                            this.$message.success(response.message || '删除成功');
                        },
                        error: (response) => {
                            this.$message.error(response.message || '删除失败');
                        }
                    });
                });
            },
            assignRolePermissions(role) {
                console.log('为角色分配权限', role);
            },
            // 打开按钮对话框
            openButtonDialog() {
                this.buttonForm = {buttonName: ''};
                this.buttonDialogVisible = true;
            },
            saveButton() {
                const url = this.buttonForm.id ? '/right/updateButton' : '/right/saveButton';
                HttpUtils.httpRequest({
                    url: url,
                    type: 'POST',
                    data: this.buttonForm,
                    success: (response) => {
                        this.queryButtons();
                        this.$message.success(response.message || (this.buttonForm.id ? '更新成功' : '新增成功'));
                    },
                    error: (response) => {
                        this.$message.error(response.message || (this.buttonForm.id ? '更新失败' : '新增失败'));
                    }
                });
                this.buttonDialogVisible = false;
            },
            editButton(button) {
                this.buttonForm = {
                    id: button.id,
                    buttonName: button.buttonName,
                    description: button.description
                };
                this.buttonDialogVisible = true;
            },
            deleteButton(button) {
                this.$confirm('确定要删除此按钮吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    HttpUtils.httpRequest({
                        url: '/right/deleteButton',
                        type: 'POST',
                        data: {id: button.id},
                        success: (response) => {
                            this.queryButtons();
                            this.$message.success(response.message || '删除成功');
                        },
                        error: (response) => {
                            this.$message.error(response.message || '删除失败');
                        }
                    });
                });
            },
            // 打开资源对话框
            openResourceDialog() {
                this.resourceForm = {resourceName: ''};
                this.resourceDialogVisible = true;
            },
            saveResource() {
                const url = this.resourceForm.id ? '/right/updateResource' : '/right/saveResource';
                HttpUtils.httpRequest({
                    url: url,
                    type: 'POST',
                    data: this.resourceForm,
                    success: (response) => {
                        this.queryResources();
                        this.$message.success(response.message || (this.resourceForm.id ? '更新成功' : '新增成功'));
                    },
                    error: (response) => {
                        this.$message.error(response.message || (this.resourceForm.id ? '更新失败' : '新增失败'));
                    }
                });
                this.resourceDialogVisible = false;
            },
            editResource(resource) {
                this.resourceForm = {
                    id: resource.id,
                    resourceName: resource.resourceName,
                    description: resource.description
                };
                this.resourceDialogVisible = true;
            },
            deleteResource(resource) {
                this.$confirm('确定要删除此资源吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    HttpUtils.httpRequest({
                        url: '/right/deleteResource',
                        type: 'POST',
                        data: {id: resource.id},
                        success: (response) => {
                            this.queryResources();
                            this.$message.success(response.message || '删除成功');
                        },
                        error: (response) => {
                            this.$message.error(response.message || '删除失败');
                        }
                    });
                });
            },
        },
        mounted() {
            this.queryRoles();
            this.getAllRoles(); // 获取所有角色
        }
    });
</script>
</body>
</html>
